name: CI/CD to VPS with Docker Swarm

on:
  push:
    branches:
      - main

permissions:
  contents: read
  packages: write

jobs:
  build-test-publish-deploy:
    runs-on: ubuntu-latest

    env:
      GHCR_PAT: ${{ secrets.GHCR_PAT }}
      VPS_HOST: ${{ secrets.VPS_HOST }}
      VPS_USER: ${{ secrets.VPS_USER }}
      VPS_PASSWORD: ${{ secrets.VPS_PASSWORD }}
      VPS_SSH_PORT: ${{ secrets.VPS_SSH_PORT }}

    steps:
      # 1Ô∏è‚É£ Checkout del c√≥digo
      - name: Checkout
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Configurar Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'

      # 3Ô∏è‚É£ Instalar dependencias
      - name: Install dependencies
        run: npm install

      # 4Ô∏è‚É£ Ejecutar tests
      - name: Run tests
        run: npm test

      # 5Ô∏è‚É£ Build de la app (si aplica)
      - name: Build app
        run: npm run build --if-present

      # 6Ô∏è‚É£ Login en GitHub Container Registry
      - name: Login to GHCR
        run: echo "${{ env.GHCR_PAT }}" | docker login ghcr.io -u adqvelez-cloud --password-stdin

      # 7Ô∏è‚É£ Construir imagen Docker
      - name: Docker Build
        run: |
          docker build -t proyecto-alexis:${{ github.sha }} .

      # 8Ô∏è‚É£ Tag y Push al GHCR
      - name: Tag & Push Image to GHCR
        run: |
          IMAGE="ghcr.io/adqvelez-cloud/proyecto-alexis"
          docker tag proyecto-alexis:${{ github.sha }} $IMAGE:latest
          docker tag proyecto-alexis:${{ github.sha }} $IMAGE:${{ github.sha }}
          
          docker push $IMAGE:latest
          docker push $IMAGE:${{ github.sha }}

      # 9Ô∏è‚É£ Copiar stack.yml al VPS
      - name: Copiar stack.yml al VPS (SCP)
        uses: appleboy/scp-action@v1
        with:
          host: ${{ env.VPS_HOST }}
          username: ${{ env.VPS_USER }}
          password: ${{ env.VPS_PASSWORD }}
          port: ${{ env.VPS_SSH_PORT }}
          source: "stack.yml"
          target: "/home/${{ env.VPS_USER }}/deploy"

      # 9.1Ô∏è‚É£ Verificar que stack.yml se copi√≥ correctamente
      - name: Verificar copia de stack.yml en VPS
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ env.VPS_HOST }}
          username: ${{ env.VPS_USER }}
          password: ${{ env.VPS_PASSWORD }}
          port: ${{ env.VPS_SSH_PORT }}
          script: |
            if [ -f ~/deploy/stack.yml ]; then
              echo "‚úÖ stack.yml copiado correctamente"
            else
              echo "‚ùå Error: stack.yml no encontrado en ~/deploy/"
              exit 1
            fi

      # üîü Deploy en el VPS via SSH
      - name: Deploy on VPS via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ env.VPS_HOST }}
          username: ${{ env.VPS_USER }}
          password: ${{ env.VPS_PASSWORD }}
          port: ${{ env.VPS_SSH_PORT }}
          script: |
            echo "üöÄ Iniciando despliegue en VPS"

            cd ~/deploy

            # Login al GHCR desde el VPS
            echo "${{ env.GHCR_PAT }}" | docker login ghcr.io -u adqvelez-cloud --password-stdin

            # Descargar la √∫ltima imagen
            docker pull ghcr.io/adqvelez-cloud/proyecto-alexis:latest

            # Eliminar stack anterior (si existe)
            docker stack rm proyecto-alexis || true

            # Esperar que el stack se libere
            sleep 10

            # Desplegar el nuevo stack limpio
            docker stack deploy --with-registry-auth -c stack.yml proyecto-alexis

            # Mostrar estado final
            docker service ls
            docker stack ps proyecto-alexis
